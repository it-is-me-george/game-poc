<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action Points Game</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0f1117;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }

        header {
            text-align: center;
            padding: 24px 0;
            border-bottom: 1px solid #2a2d3a;
            margin-bottom: 24px;
            position: relative;
        }
        header h1 { font-size: 28px; color: #fff; margin-bottom: 8px; }
        .config-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 13px;
            color: #888;
        }
        .config-info span { background: #1a1d2a; padding: 4px 10px; border-radius: 6px; }

        .header-right {
            position: absolute;
            right: 0;
            top: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .role-badge {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
        }
        .role-admin { background: #3a2050; color: #c084fc; }
        .role-user { background: #1a3520; color: #5bef8f; }
        .logout-btn {
            padding: 6px 14px;
            background: #2a2d3a;
            color: #aaa;
            border: 1px solid #3a3d4a;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }
        .logout-btn:hover { background: #3a3d4a; color: #fff; }

        /* Экран логина */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 16px;
        }
        .login-screen h2 { font-size: 24px; color: #fff; margin-bottom: 8px; }
        .login-screen p { color: #888; font-size: 14px; margin-bottom: 8px; }
        .login-form {
            display: flex;
            gap: 8px;
            width: 100%;
            max-width: 360px;
        }
        .login-form input {
            flex: 1;
            padding: 12px 16px;
            background: #1a1d2a;
            border: 1px solid #2a2d3a;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            outline: none;
            text-align: center;
            letter-spacing: 2px;
        }
        .login-form input:focus { border-color: #5b6eef; }
        .login-form button {
            padding: 12px 24px;
            background: #5b6eef;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
        }
        .login-form button:hover { background: #4a5bdb; }
        .login-error {
            color: #ef5b5b;
            font-size: 14px;
            min-height: 20px;
        }

        /* Форма регистрации */
        .register {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }
        .register textarea {
            flex: 1;
            padding: 10px 14px;
            background: #1a1d2a;
            border: 1px solid #2a2d3a;
            border-radius: 8px;
            color: #fff;
            font-size: 15px;
            outline: none;
            resize: vertical;
            min-height: 42px;
            font-family: inherit;
        }
        .register textarea:focus { border-color: #5b6eef; }
        .register .hint { font-size: 11px; color: #555; align-self: center; white-space: nowrap; }
        .register button {
            padding: 10px 20px;
            background: #5b6eef;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
        }
        .register button:hover { background: #4a5bdb; }

        /* Карточка команды (для обычного пользователя) */
        .team-card {
            background: #1a1d2a;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            margin-bottom: 32px;
        }
        .team-card .tc-name {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 12px;
        }
        .team-card .tc-points {
            font-size: 48px;
            font-weight: 800;
            color: #5bef8f;
            font-variant-numeric: tabular-nums;
        }
        .team-card .tc-label {
            font-size: 14px;
            color: #888;
            margin-top: 4px;
        }
        .team-card .tc-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .named-spend-btn {
            padding: 10px 18px;
            background: #2a2d3a;
            color: #ccc;
            border: 1px solid #3a3d4a;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        .named-spend-btn:hover { background: #ef5b5b; color: #fff; border-color: #ef5b5b; }
        .named-spend-btn:disabled { opacity: 0.3; cursor: not-allowed; background: #2a2d3a; color: #666; border-color: #3a3d4a; }
        .named-spend-btn .btn-cost { font-weight: 700; }

        /* Таблица */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 32px;
        }
        th {
            text-align: left;
            padding: 10px 12px;
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
            border-bottom: 1px solid #2a2d3a;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #1a1d2a;
            vertical-align: middle;
        }
        tr:hover td { background: #161822; }
        .team-name { font-weight: 600; color: #fff; }
        .points {
            font-weight: 700;
            font-size: 18px;
            color: #5bef8f;
            font-variant-numeric: tabular-nums;
        }
        .actions { display: flex; gap: 6px; flex-wrap: wrap; }
        .spend-btn {
            padding: 5px 12px;
            background: #2a2d3a;
            color: #ccc;
            border: 1px solid #3a3d4a;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }
        .spend-btn:hover { background: #ef5b5b; color: #fff; border-color: #ef5b5b; }
        .spend-btn:disabled { opacity: 0.3; cursor: not-allowed; background: #2a2d3a; color: #666; border-color: #3a3d4a; }
        .empty-row td { text-align: center; color: #555; padding: 32px; }

        .team-code {
            font-family: monospace;
            font-size: 12px;
            color: #888;
            background: #0f1117;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Лог */
        .log-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #aaa;
        }
        .log {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .log-entry {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: #1a1d2a;
            border-radius: 6px;
            font-size: 13px;
            position: relative;
        }
        .log-entry .log-uuid {
            font-family: monospace;
            font-size: 11px;
            color: #666;
        }
        .log-entry .log-uuid .uuid-full {
            display: none;
        }
        .log-entry:hover .log-uuid .uuid-short {
            display: none;
        }
        .log-entry:hover .log-uuid .uuid-full {
            display: inline;
            color: #5bef8f;
        }
        .log-entry .cost { color: #ef5b5b; font-weight: 600; }
        .log-entry .time { color: #555; }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            color: #fff;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }
        .toast.show { opacity: 1; }
        .toast.error { background: #ef5b5b; }
        .toast.success { background: #5bef8f; color: #000; }

        /* Модалка кодов */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
        .modal {
            background: #1a1d2a;
            border-radius: 12px;
            padding: 24px;
            max-width: 420px;
            width: 90%;
        }
        .modal h3 { color: #fff; margin-bottom: 16px; font-size: 18px; }
        .modal .code-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
        .modal .code-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #0f1117;
            border-radius: 6px;
        }
        .modal .code-item .name { color: #fff; font-weight: 600; }
        .modal .code-item .code {
            font-family: monospace;
            font-size: 16px;
            letter-spacing: 2px;
            color: #5bef8f;
            font-weight: 700;
        }
        .modal button {
            width: 100%;
            padding: 10px;
            background: #5b6eef;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
        }
        .modal button:hover { background: #4a5bdb; }

        /* Пагинация */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            margin-top: 16px;
        }
        .pagination button {
            padding: 6px 12px;
            background: #2a2d3a;
            color: #ccc;
            border: 1px solid #3a3d4a;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }
        .pagination button:hover { background: #3a3d4a; color: #fff; }
        .pagination button:disabled { opacity: 0.3; cursor: not-allowed; }
        .pagination button.active { background: #5b6eef; color: #fff; border-color: #5b6eef; }
        .pagination .page-info { font-size: 12px; color: #666; }

        /* Админ-панель управления */
        .admin-controls {
            background: #1a1d2a;
            border: 1px solid #2a2d3a;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .admin-controls .ctrl-label {
            font-size: 13px;
            color: #888;
        }
        .admin-controls input[type="number"] {
            width: 70px;
            padding: 6px 8px;
            background: #0f1117;
            border: 1px solid #3a3d4a;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            text-align: center;
            outline: none;
        }
        .admin-controls input[type="number"]:focus { border-color: #5b6eef; }
        .ctrl-btn {
            padding: 6px 14px;
            border: 1px solid #3a3d4a;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            background: #2a2d3a;
            color: #ccc;
        }
        .ctrl-btn:hover { background: #3a3d4a; color: #fff; }
        .ctrl-btn.primary { background: #5b6eef; color: #fff; border-color: #5b6eef; }
        .ctrl-btn.primary:hover { background: #4a5bdb; }
        .ctrl-btn.danger { background: #4a1a1a; color: #ef5b5b; border-color: #5a2a2a; }
        .ctrl-btn.danger:hover { background: #ef5b5b; color: #fff; }
        .ctrl-sep { width: 1px; height: 24px; background: #2a2d3a; }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Экран входа -->
        <div id="login-screen" class="login-screen hidden">
            <img src="/static/logo.jpeg" alt="Logo" style="width:80px;border-radius:12px;margin-bottom:8px;">
            <h2>Action Points Game</h2>
            <p>Введите код для входа</p>
            <div class="login-form">
                <input type="text" id="login-code" placeholder="Код доступа" autocomplete="off">
                <button onclick="doLogin()">Войти</button>
            </div>
            <div class="login-error" id="login-error"></div>
        </div>

        <!-- Основной интерфейс -->
        <div id="main-app" class="hidden">
            <header>
                <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:8px;">
                    <img src="/static/logo.jpeg" alt="Logo" style="width:40px;border-radius:8px;">
                    <h1 style="margin:0">Action Points Game</h1>
                </div>
                <div class="config-info" id="config-info"></div>
                <div class="header-right">
                    <span class="role-badge" id="role-badge"></span>
                    <button class="logout-btn" onclick="doLogout()">Выйти</button>
                </div>
            </header>

            <!-- Форма создания (только админ) -->
            <div class="register hidden" id="register-section">
                <textarea id="team-name" placeholder="Названия команд (каждая с новой строки или через запятую)" rows="2"></textarea>
                <button onclick="createTeam()">Создать</button>
            </div>

            <!-- Админ-панель управления -->
            <div class="admin-controls hidden" id="admin-controls">
                <span class="ctrl-label">Очков за тик:</span>
                <input type="number" id="cfg-points" min="0" value="100">
                <span class="ctrl-label">Интервал (сек):</span>
                <input type="number" id="cfg-interval" min="1" value="60">
                <button class="ctrl-btn primary" onclick="saveSettings()">Сохранить</button>
                <div class="ctrl-sep"></div>
                <span class="ctrl-label">Всем командам:</span>
                <input type="number" id="add-points-amount" min="1" value="10" style="width:60px">
                <button class="ctrl-btn" onclick="addPointsAll()">+ Начислить</button>
                <div class="ctrl-sep"></div>
                <button class="ctrl-btn danger" onclick="resetPointsAll()">Обнулить всё</button>
            </div>

            <!-- Карточка команды (только обычный пользователь) -->
            <div id="team-card-section" class="hidden">
                <div class="team-card">
                    <div class="tc-name" id="tc-name"></div>
                    <div class="tc-points" id="tc-points">0</div>
                    <div class="tc-label">очков</div>
                    <div class="tc-actions" id="tc-actions"></div>
                </div>
            </div>

            <!-- Таблица всех команд (только админ) -->
            <div id="teams-table-section" class="hidden">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Команда</th>
                            <th>Код</th>
                            <th>Очки</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="teams-body">
                        <tr class="empty-row"><td colspan="5">Нет команд</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="log-title">Лог списаний</div>
            <input type="text" id="log-search" placeholder="Поиск по имени или UUID..." oninput="onSearchInput()" style="
                width:100%; padding:8px 14px; margin-bottom:12px; background:#1a1d2a;
                border:1px solid #2a2d3a; border-radius:8px; color:#fff; font-size:14px; outline:none;
            " onfocus="this.style.borderColor='#5b6eef'" onblur="this.style.borderColor='#2a2d3a'">
            <div class="log" id="log"></div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let spendOptions = [];
        let spendNamed = [];
        let allReports = [];
        let currentPage = 1;
        let totalPages = 1;
        let currentRole = null;
        let currentTeamId = null;
        let pollInterval = null;

        function showToast(msg, type) {
            const t = document.getElementById("toast");
            t.textContent = msg;
            t.className = "toast show " + type;
            setTimeout(() => t.className = "toast", 2500);
        }

        // ---- Авторизация ----

        async function checkAuth() {
            const res = await fetch("/api/me");
            const data = await res.json();
            if (data.role) {
                currentRole = data.role;
                currentTeamId = data.team_id || null;
                showApp(data);
            } else {
                showLogin();
            }
        }

        function showLogin() {
            currentRole = null;
            currentTeamId = null;
            document.getElementById("login-screen").classList.remove("hidden");
            document.getElementById("main-app").classList.add("hidden");
            document.getElementById("login-error").textContent = "";
            document.getElementById("login-code").value = "";
            document.getElementById("login-code").focus();
            if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
        }

        function showApp(userData) {
            document.getElementById("login-screen").classList.add("hidden");
            document.getElementById("main-app").classList.remove("hidden");

            const badge = document.getElementById("role-badge");
            if (currentRole === "admin") {
                badge.textContent = "Админ";
                badge.className = "role-badge role-admin";
                document.getElementById("register-section").classList.remove("hidden");
                document.getElementById("admin-controls").classList.remove("hidden");
                document.getElementById("teams-table-section").classList.remove("hidden");
                document.getElementById("team-card-section").classList.add("hidden");
            } else {
                badge.textContent = userData.team_name || "Команда";
                badge.className = "role-badge role-user";
                document.getElementById("register-section").classList.add("hidden");
                document.getElementById("admin-controls").classList.add("hidden");
                document.getElementById("teams-table-section").classList.add("hidden");
                document.getElementById("team-card-section").classList.remove("hidden");
            }

            loadConfig().then(() => { loadTeams(); loadReports(); });
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(() => { loadTeams(); loadReports(); }, 5000);
        }

        async function doLogin() {
            const code = document.getElementById("login-code").value.trim();
            if (!code) return;
            const errEl = document.getElementById("login-error");
            errEl.textContent = "";
            const res = await fetch("/api/login", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({code})
            });
            const data = await res.json();
            if (!res.ok) {
                errEl.textContent = data.error || "Ошибка входа";
                return;
            }
            currentRole = data.role;
            currentTeamId = data.team_id || null;
            showApp(data);
        }

        async function doLogout() {
            await fetch("/api/logout", {method: "POST"});
            showLogin();
        }

        // ---- Данные ----

        async function loadConfig() {
            const res = await fetch("/api/config");
            const cfg = await res.json();
            spendOptions = cfg.spend_options;
            spendNamed = cfg.spend_named || [];
            document.getElementById("config-info").innerHTML =
                `<span>+${cfg.points_per_tick} очков / ${cfg.tick_interval}с</span>` +
                `<span>Списание: ${cfg.spend_options.join(", ")}</span>`;
            document.getElementById("cfg-points").value = cfg.points_per_tick;
            document.getElementById("cfg-interval").value = cfg.tick_interval;
        }

        async function loadTeams() {
            const res = await fetch("/api/teams");
            if (res.status === 401) { showLogin(); return; }
            const teams = await res.json();

            if (currentRole === "admin") {
                const tbody = document.getElementById("teams-body");
                if (!teams.length) {
                    tbody.innerHTML = '<tr class="empty-row"><td colspan="5">Нет команд</td></tr>';
                    return;
                }
                tbody.innerHTML = teams.map((t, i) => `
                    <tr>
                        <td>${i + 1}</td>
                        <td class="team-name">${esc(t.name)}</td>
                        <td><span class="team-code">${t.code ? esc(t.code) : "—"}</span></td>
                        <td class="points">${t.points}</td>
                        <td class="actions">
                            ${spendOptions.map(amt =>
                                `<button class="spend-btn" ${t.points < amt ? "disabled" : ""}
                                    onclick="spend(${t.id}, ${amt})">-${amt}</button>`
                            ).join("")}
                            <button class="spend-btn" style="color:#ef5b5b;border-color:#5a2a2a"
                                onclick="deleteTeam(${t.id}, '${esc(t.name)}')">&#x2715;</button>
                        </td>
                    </tr>
                `).join("");
            } else {
                // Обычный пользователь — карточка своей команды
                if (teams.length) {
                    const t = teams[0];
                    document.getElementById("tc-name").textContent = t.name;
                    document.getElementById("tc-points").textContent = t.points;
                    document.getElementById("tc-actions").innerHTML = spendNamed.map(s =>
                        `<button class="named-spend-btn" ${t.points < s.cost ? "disabled" : ""}
                            onclick="spend(${t.id}, ${s.cost}, '${esc(s.name)}')">${esc(s.name)} <span class="btn-cost">-${s.cost}</span></button>`
                    ).join("");
                }
            }
        }

        async function loadReports(page) {
            if (page !== undefined) currentPage = page;
            const query = (document.getElementById("log-search").value || "").trim();
            let url = `/api/reports?page=${currentPage}&per_page=20`;
            if (query) url += `&q=${encodeURIComponent(query)}`;
            const res = await fetch(url);
            if (res.status === 401) { showLogin(); return; }
            const data = await res.json();
            allReports = data.items;
            currentPage = data.page;
            totalPages = data.total_pages;
            renderLog();
            renderPagination(data.total);
        }

        function renderPagination(total) {
            const el = document.getElementById("pagination");
            if (totalPages <= 1) { el.innerHTML = ""; return; }
            let html = `<button ${currentPage <= 1 ? "disabled" : ""} onclick="loadReports(${currentPage - 1})">&laquo;</button>`;
            const start = Math.max(1, currentPage - 2);
            const end = Math.min(totalPages, currentPage + 2);
            if (start > 1) html += `<button onclick="loadReports(1)">1</button>`;
            if (start > 2) html += `<span class="page-info">...</span>`;
            for (let p = start; p <= end; p++) {
                html += `<button class="${p === currentPage ? 'active' : ''}" onclick="loadReports(${p})">${p}</button>`;
            }
            if (end < totalPages - 1) html += `<span class="page-info">...</span>`;
            if (end < totalPages) html += `<button onclick="loadReports(${totalPages})">${totalPages}</button>`;
            html += `<button ${currentPage >= totalPages ? "disabled" : ""} onclick="loadReports(${currentPage + 1})">&raquo;</button>`;
            html += `<span class="page-info">${total} записей</span>`;
            el.innerHTML = html;
        }

        async function createTeam() {
            const input = document.getElementById("team-name");
            const raw = input.value.trim();
            if (!raw) return;
            const names = raw.split(/[\n,]+/).map(s => s.trim()).filter(Boolean);
            if (!names.length) return;
            const res = await fetch("/api/teams", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({names})
            });
            const data = await res.json();
            if (!res.ok) {
                showToast(data.error, "error");
                return;
            }
            input.value = "";

            // Показать коды созданных команд
            if (data.codes && Object.keys(data.codes).length) {
                showCodesModal(data.codes);
            }

            const parts = [];
            if (data.created.length) parts.push(`Создано: ${data.created.length}`);
            if (data.duplicates.length) parts.push(`Дубли: ${data.duplicates.join(", ")}`);
            showToast(parts.join(" | ") || "Готово", data.duplicates.length ? "error" : "success");
            loadTeams();
        }

        function showCodesModal(codes) {
            const overlay = document.createElement("div");
            overlay.className = "modal-overlay";
            overlay.innerHTML = `
                <div class="modal">
                    <h3>Коды доступа команд</h3>
                    <div class="code-list">
                        ${Object.entries(codes).map(([name, code]) => `
                            <div class="code-item">
                                <span class="name">${esc(name)}</span>
                                <span class="code">${esc(code)}</span>
                            </div>
                        `).join("")}
                    </div>
                    <button onclick="this.closest('.modal-overlay').remove()">Закрыть</button>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        async function spend(teamId, amount, label) {
            const body = {amount};
            if (label) body.label = label;
            const res = await fetch(`/api/teams/${teamId}/spend`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(body)
            });
            const data = await res.json();
            if (!res.ok) {
                showToast(data.error, "error");
                return;
            }
            if (data.uuid) {
                showUuidModal(data.uuid, amount, label);
            } else {
                showToast(`Списано ${amount} очков` + (label ? ` (${label})` : ""), "success");
            }
            loadTeams();
            loadReports();
        }

        function showUuidModal(txnUuid, amount, label) {
            const overlay = document.createElement("div");
            overlay.className = "modal-overlay";
            overlay.innerHTML = `
                <div class="modal">
                    <h3>Списание выполнено</h3>
                    <div style="text-align:center;margin-bottom:16px;">
                        <div style="color:#888;font-size:13px;margin-bottom:4px;">${label ? esc(label) + ' · ' : ''}-${amount} очков</div>
                        <div style="font-family:monospace;font-size:18px;color:#5bef8f;font-weight:700;letter-spacing:1px;
                            background:#0f1117;padding:12px;border-radius:8px;word-break:break-all;user-select:all;">${esc(txnUuid)}</div>
                        <div style="color:#555;font-size:12px;margin-top:6px;">Сохраните этот код</div>
                    </div>
                    <button onclick="this.closest('.modal-overlay').remove()">Закрыть</button>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        let searchTimer = null;
        function onSearchInput() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => loadReports(1), 300);
        }

        function renderLog() {
            const log = document.getElementById("log");
            if (!allReports.length) {
                log.innerHTML = '<div class="log-entry" style="color:#555">Нет записей</div>';
                return;
            }
            log.innerHTML = allReports.map(r => `
                <div class="log-entry">
                    <span>${esc(r.team_name)}</span>
                    ${r.label ? `<span style="color:#aaa">${esc(r.label)}</span>` : ""}
                    <span class="cost">${r.points_before != null ? `${r.points_before} → ${r.points_after}` : `-${r.cost}`}</span>
                    ${r.uuid ? `<span class="log-uuid"><span class="uuid-short">${esc(r.uuid.slice(0,8))}</span><span class="uuid-full">${esc(r.uuid)}</span></span>` : ""}
                    <span class="time">${fmtTime(r.created_at)}</span>
                </div>
            `).join("");
        }

        async function deleteTeam(teamId, name) {
            if (!confirm(`Удалить команду "${name}" и все её отчёты?`)) return;
            const res = await fetch(`/api/teams/${teamId}`, {method: "DELETE"});
            const data = await res.json();
            if (!res.ok) { showToast(data.error, "error"); return; }
            showToast(`Команда "${name}" удалена`, "success");
            loadTeams();
            loadReports();
        }

        async function saveSettings() {
            const pts = parseInt(document.getElementById("cfg-points").value);
            const interval = parseInt(document.getElementById("cfg-interval").value);
            const res = await fetch("/api/admin/settings", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({points_per_tick: pts, tick_interval: interval})
            });
            const data = await res.json();
            if (!res.ok) { showToast(data.error, "error"); return; }
            showToast(`Настройки: +${pts} очков / ${interval}с`, "success");
            loadConfig();
        }

        async function addPointsAll() {
            const amount = parseInt(document.getElementById("add-points-amount").value);
            if (!amount || amount <= 0) return;
            const res = await fetch("/api/admin/add-points", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({amount})
            });
            const data = await res.json();
            if (!res.ok) { showToast(data.error, "error"); return; }
            showToast(`+${amount} очков всем командам`, "success");
            loadTeams();
        }

        async function resetPointsAll() {
            if (!confirm("Обнулить очки всех команд?")) return;
            const res = await fetch("/api/admin/reset-points", {
                method: "POST",
                headers: {"Content-Type": "application/json"}
            });
            const data = await res.json();
            if (!res.ok) { showToast(data.error, "error"); return; }
            showToast("Очки всех команд обнулены", "success");
            loadTeams();
        }

        function esc(s) {
            const d = document.createElement("div");
            d.textContent = s;
            return d.innerHTML;
        }

        function fmtTime(ts) {
            if (!ts) return "";
            const d = new Date(ts + "Z");
            return d.toLocaleDateString("ru-RU", {day: "2-digit", month: "2-digit", year: "numeric"})
                + " " + d.toLocaleTimeString("ru-RU", {hour: "2-digit", minute: "2-digit", second: "2-digit"});
        }

        // Enter для логина
        document.getElementById("login-code").addEventListener("keydown", e => {
            if (e.key === "Enter") doLogin();
        });

        // Ctrl+Enter для создания команды
        document.getElementById("team-name").addEventListener("keydown", e => {
            if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) createTeam();
        });

        // Старт
        checkAuth();
    </script>
</body>
</html>
